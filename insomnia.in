#!/bin/sh
set -e

if [ $# -lt 1 ]; then
	echo "USAGE: ${0##*/} SERVER [CHANNEL]" 1>&2
	exit 1
fi

export PATH="${PATH}:@LIBDIR@"
export INSOMNIA_DIR="${INSOMNIA_DIR:-$HOME/irc}/${1}/${2}"

# tmux doesn't copy environment variables, pass them explicitly.
vars="INSOMNIA_DIR="${INSOMNIA_DIR}" PATH="${PATH}:@LIBDIR@""

if [ ! -d "${INSOMNIA_DIR}" ]; then
	echo "'${INSOMNIA_DIR}' is not a directory or doesn't exist" 1>&2
	exit 1
fi

while [ ! -p "${INSOMNIA_DIR}/in" ]; do
	echo "Input FIFO doesn't exist yet, sleeping..." 1>&2
	sleep 3
done

# TODO: Special characters such as `.` or `#` cannot be used in tmux
# sesion names, thus we simply pick a very simple name for the session.
# The issue here being that the name is not unique and only a single
# insomnia tmux instance can thus exist at a time.
session="insomnia"

if tmux has-session -t "=${session}" >/dev/null 2>&1; then
	echo "An insomnia tmux session does already exits" 1>&2
	exit 1
fi

# TODO: It would be nice if we could significantly reduce the height of
# the window for insomnia-input. Unfortunately, tmux has a minimum pane
# height of 2 rows making this hardly possible.
tmux new-session -d -s "${session}" \
	"env ${vars} insomnia-output"
tmux set-hook -t "=${session}" client-detached \
	"kill-session -t '=${session}'"
tmux set-hook -t "=${session}" client-resized \
	"resize-pane -t '=insomnia.bottom' -y 2"
tmux split-window -t "=${session}:^" \
	"env ${vars} insomnia-input"
tmux rename-window -t "=${session}" \
	"$(insomnia-topic)"

# This is a workaround for https://github.com/tmux/tmux/issues/1480
tmux set-option -t "=${session}" main-pane-height 1000000
tmux set-hook -t "=${session}" client-attached \
	"select-layout -t "=${session}." main-horizontal"

exec tmux attach -t "${session}"
